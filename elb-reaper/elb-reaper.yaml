  apiVersion: v1
  description: Automatically clean up ELB v2 load balancers that have no targets

  parameters:
    region:
      description: The AWS region to run in
      default: us-east-1
    dryRun:
      description: True if this workflow should only print the resources it would delete
      default: 'true'
  steps:
  - name: describe-ELBv2-load-balancers
    image: kenazk/elbv2-describe-load-balancers
    spec:
      aws: &aws
        region: !Parameter region
        accessKeyID: !Secret aws.accessKeyID
        secretAccessKey: !Secret aws.secretAccessKey
  - name: filter-empty-load-balancers
    image: projectnebula/core:latest-python
    spec:
      aws: &aws
        region: !Parameter region
        accessKeyID: !Secret aws.accessKeyID
        secretAccessKey: !Secret aws.secretAccessKey
      loadbalancers: !Output {from: describe-ELBv2-load-balancers, name: loadbalancers}
      targetgroups: !Output {from: describe-ELBv2-load-balancers, name: targetgroups}
      targets: !Output {from: describe-ELBv2-load-balancers, name: targets}
      confetti: true
    inputFile: https://gist.githubusercontent.com/kenazk/f34ef5ba0e043106aab3309b9a2e4b62/raw/0506011809c3a80f70ad9dc707211e1a2004d053/filter.py
  - name: approval
    description: Wait for manual approval to delete load balancers 
    type: approval
    dependsOn: filter-empty-load-balancers
  - name: delete-load-balancers
    image: kenazk/elbv2-delete-load-balancers
    dependsOn: approval 
    when: 
      - !Fn.equals [!Parameter dryRun, 'false']
    spec:
      aws: *aws
      elb_arns: !Output {from: filter-empty-load-balancers, name: elb_arns}
